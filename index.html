<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JAD Connect - Audit Patrimonial</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        /* DESIGN TOKENS JAD CONSEIL */
        :root {
            --bg-color: #F8EFEA;
            --primary-vin: #591B2A;
            --accent-gold: #FFBD59;
            --accent-gold-50: #FFBD50;
            --accent-pink: #EDB3CB;
            --white: #FFFFFF;
            --shadow-soft: 0 5px 20px rgba(89, 27, 42, 0.05);
            --radius: 12px;
            --title-size: 1.8rem;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        html, body {
            min-height: 100%;
            background-color: var(--bg-color);
            color: var(--primary-vin);
            font-family: 'Montserrat', sans-serif !important;
            -webkit-font-smoothing: antialiased;
            /* ✅ CONFIGURATION WIX : Scroll vertical actif */
            overflow-y: auto; 
            overflow-x: hidden;
        }

        /* ✅ BARRE DE DÉFILEMENT PERSONNALISÉE LIE-DE-VIN */
        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: var(--bg-color); }
        ::-webkit-scrollbar-thumb { background: var(--primary-vin); border-radius: 10px; border: 2px solid var(--bg-color); }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent-gold); }

        body { display: flex; flex-direction: column; }

        /* HEADER */
        .top-header {
            width: 100%;
            padding: 15px 40px;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            height: 80px;
            flex-shrink: 0;
            gap: 20px;
            visibility: hidden;
            z-index: 10;
        }
        .header-logo { height: 40px; width: auto; object-fit: contain; }
        .header-sep { width: 1px; height: 30px; background-color: var(--primary-vin); display: none; }

        #app-wrapper {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .page {
            width: 100%;
            max-width: 900px;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.4s ease-out;
            text-align: center;
            margin: auto;
        }
        .page.active { display: flex; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1, .big-title, .page-title {
            font-size: var(--title-size);
            font-weight: 700;
            margin-bottom: 25px;
            line-height: 1.2;
        }

        .subtitle { font-size: 1.1rem; margin-bottom: 30px; font-weight: 400; }

        .form-container { text-align: left; margin: 0 auto; width: 100%; max-width: 550px; }
        .field { margin-bottom: 20px; }

        label {
            display: block;
            font-weight: 700;
            font-size: 0.8rem;
            margin-bottom: 8px;
            text-transform: uppercase;
            font-family: 'Montserrat', sans-serif !important;
        }

        input, select, textarea {
            width: 100%;
            padding: 14px 18px;
            border: 1.5px solid rgba(89, 27, 42, 0.15);
            background: var(--white);
            color: var(--primary-vin);
            border-radius: var(--radius);
            font-size: 1rem;
            font-family: 'Montserrat', sans-serif !important;
            outline: none;
            transition: all 0.3s ease;
        }
        textarea { resize: none; height: 100px; }
        input:hover, select:hover, textarea:hover { border-color: var(--accent-gold); }

        /* NAVIGATION */
        .nav-actions { display: flex; justify-content: center; align-items: center; gap: 20px; margin-top: 30px; }
        
        .btn-jad {
            background: var(--primary-vin);
            color: var(--white);
            border: none;
            padding: 18px 50px;
            font-weight: 700;
            font-size: 0.9rem;
            border-radius: 50px;
            cursor: pointer;
            text-transform: uppercase;
            font-family: 'Montserrat', sans-serif !important;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(89, 27, 42, 0.15);
        }
        .btn-jad:hover { background-color: var(--accent-gold); color: var(--primary-vin); transform: translateY(-1px); }

        .btn-prev {
            background: transparent;
            color: var(--primary-vin);
            border: 1.5px solid var(--primary-vin);
            padding: 12px 30px;
            font-weight: 700;
            font-size: 0.75rem;
            border-radius: 50px;
            cursor: pointer;
            font-family: 'Montserrat', sans-serif !important;
            transition: all 0.3s ease;
        }
        .btn-prev:hover { background-color: var(--accent-pink); border-color: var(--accent-pink); }

        /* GRILLES */
        .option-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; }
        .grid-needs { grid-template-columns: repeat(3, 1fr); }

        .option-card {
            border: 1.5px solid rgba(89, 27, 42, 0.1);
            background: var(--white);
            padding: 15px;
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 85px;
            font-size: 0.85rem;
            box-shadow: var(--shadow-soft);
        }
        .option-card:hover { border-color: var(--accent-gold); }
        .option-card.selected { background-color: var(--primary-vin); color: var(--white); border-color: var(--primary-vin); }

        .logos-center { display: flex; justify-content: center; align-items: center; gap: 30px; margin-bottom: 40px; }
        .logo-center-img { height: 75px; width: auto; object-fit: contain; }
        .center-sep { width: 1px; height: 50px; background-color: var(--primary-vin); display: none; }

        .summary-box {
            text-align: left;
            background: var(--white);
            padding: 30px;
            border-radius: var(--radius);
            margin-bottom: 20px;
            box-shadow: var(--shadow-soft);
            max-height: 400px;
            overflow-y: auto;
            width: 100%;
            font-size: 0.85rem;
        }
        .summary-section { margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; }

        /* ✅ MEDIA QUERIES MOBILE */
        @media (max-width: 650px) {
            :root { --title-size: 1.4rem; }
            .option-grid, .grid-needs { grid-template-columns: 1fr; }
            .nav-actions { flex-direction: column; width: 100%; }
            .btn-jad, .btn-prev { width: 100%; }
            .logo-center-img { height: 50px; }
            .top-header { padding: 15px; }
        }
    </style>
</head>
<body>

<div id="error-msg" style="position:fixed; top:20px; left:50%; transform:translateX(-50%); background:var(--primary-vin); color:white; padding:12px 30px; border-radius:8px; display:none; z-index:1000;">Champs obligatoires manquants.</div>

<div class="top-header" id="main-header">
    <img src="" id="header-logo-partner" class="header-logo" style="display:none;">
    <div class="header-sep" id="header-sep"></div>
    <img src="https://static.wixstatic.com/media/372258_429b8cad6bec47ecb20949a0b1fe0142~mv2.png" class="header-logo" alt="Logo JAD">
</div>

<div id="app-wrapper">
    <div id="page1" class="page active">
        <h1>Bienvenue sur <span style="color:var(--accent-gold)">JAD Connect</span></h1>
        <p class="subtitle">Un outil d'audit exclusif conçu pour vous et vos clients.</p>
        <div class="form-container" style="max-width: 450px;">
            <div class="field"><label>Cabinet</label><input type="text" id="input-cabinet"></div>
            <div class="field"><label>Collaborateur</label><input type="text" id="input-collab"></div>
            <div class="field"><label>Client - Société</label><input type="text" id="input-client"></div>
        </div>
        <div class="nav-actions">
            <button class="btn-jad" onclick="toPage2()">Démarrer l'audit</button>
        </div>
    </div>

    <div id="page2" class="page">
        <div class="logos-center">
            <img src="" id="center-logo-partner" class="logo-center-img" style="display:none;">
            <div class="center-sep" id="center-sep-main"></div>
            <img src="https://static.wixstatic.com/media/372258_429b8cad6bec47ecb20949a0b1fe0142~mv2.png" class="logo-center-img" alt="Logo JAD">
        </div>
        <h1 id="welcome-text"></h1>
        <div class="nav-actions">
            <button class="btn-prev" onclick="showPage(1)">Précédent</button>
            <button class="btn-jad" onclick="showPage(3)">Commencer l'audit</button>
        </div>
    </div>

    <div id="page3" class="page">
        <h1 class="page-title">Quelle est la forme juridique de la société ?</h1>
        <div class="form-container">
            <div class="field">
                <select id="select-forme">
                    <option value="" disabled selected>Sélectionner...</option>
                    <option value="EI">EI (Entreprise Individuelle)</option>
                    <option value="EURL">EURL</option>
                    <option value="Holding">Holding</option>
                    <option value="Micro Entreprise">Micro Entreprise</option>
                    <option value="SA">SA (Société Anonyme)</option>
                    <option value="SARL">SARL (Société à Responsabilité Limitée)</option>
                    <option value="SAS">SAS / SASU</option>
                    <option value="SELARL">SELARL</option>
                    <option value="SNC">SNC</option>
                    <option value="Autre">Autre</option>
                </select>
            </div>
        </div>
        <div class="nav-actions">
            <button class="btn-prev" onclick="showPage(2)">Précédent</button>
            <button class="btn-jad" onclick="savePage3()">Suivant</button>
        </div>
    </div>

    <div id="page4" class="page">
        <h1 class="page-title">Quel est l'effectif de l'entreprise ?</h1>
        <div class="option-grid">
            <div class="option-card" onclick="setOption('effectif', '0', this)">0 salarié</div>
            <div class="option-card" onclick="setOption('effectif', '1-10', this)">1 à 10 salariés</div>
            <div class="option-card" onclick="setOption('effectif', '11-49', this)">11 à 49 salariés</div>
            <div class="option-card" onclick="setOption('effectif', '50+', this)">50 salariés et +</div>
        </div>
        <div class="nav-actions">
            <button class="btn-prev" onclick="showPage(3)">Précédent</button>
            <button class="btn-jad" onclick="showPage(5)">Suivant</button>
        </div>
    </div>

    <div id="page5" class="page">
        <h1 class="page-title">Statut social du dirigeant ?</h1>
        <div class="option-grid">
            <div class="option-card" onclick="setOption('statut', 'TNS', this)">TNS</div>
            <div class="option-card" onclick="setOption('statut', 'Assimilé Salarié', this)">Assimilé Salarié</div>
        </div>
        <div class="nav-actions">
            <button class="btn-prev" onclick="showPage(4)">Précédent</button>
            <button class="btn-jad" onclick="showPage(6)">Suivant</button>
        </div>
    </div>

    <div id="page6" class="page">
        <h1 class="page-title">Excédent de trésorerie stable (&gt; 30k€) ?</h1>
        <div class="option-grid">
            <div class="option-card" onclick="setOption('treso', 'Oui', this)">Oui</div>
            <div class="option-card" onclick="setOption('treso', 'Non', this)">Non</div>
        </div>
        <div class="nav-actions">
            <button class="btn-prev" onclick="showPage(5)">Précédent</button>
            <button class="btn-jad" onclick="nextFromPage6()">Suivant</button>
        </div>
    </div>

    <div id="page6b" class="page">
        <h1 class="page-title">Précisions Trésorerie</h1>
        <div class="form-container">
            <div class="field"><label>Montant trésorerie</label><input type="text" id="in_treso_montant" onblur="handleCurrencyFormat(this)"></div>
            <div class="field"><label>BFR</label><input type="text" id="in_treso_bfr" onblur="handleCurrencyFormat(this)"></div>
            <div class="field"><label>Optimisable</label><input type="text" id="in_treso_excedent" onblur="handleCurrencyFormat(this)"></div>
        </div>
        <div class="nav-actions">
            <button class="btn-prev" onclick="showPage(6)">Précédent</button>
            <button class="btn-jad" onclick="showPage(7)">Suivant</button>
        </div>
    </div>

    <div id="page7" class="page">
        <h1 class="page-title">Périmètre de l'audit</h1>
        <div class="option-grid">
            <div class="option-card" onclick="toggleOption('typesBesoins', 'Dirigeant', this)">Pour le Dirigeant</div>
            <div class="option-card" onclick="toggleOption('typesBesoins', 'Société', this)">Pour la Société</div>
        </div>
        <div class="nav-actions">
            <button class="btn-prev" onclick="prevFromPage7()">Précédent</button>
            <button class="btn-jad" onclick="nextFromPage7()">Suivant</button>
        </div>
    </div>

    <div id="page8" class="page">
        <h1 class="page-title">Besoins <span style="color:var(--accent-gold)">Dirigeant</span></h1>
        <div class="option-grid grid-needs">
            <div class="option-card" onclick="toggleOption('besoinsDir', 'Arrêt de travail', this)">Arrêt de travail</div>
            <div class="option-card" onclick="toggleOption('besoinsDir', 'Retraite', this)">Retraite</div>
            <div class="option-card" onclick="toggleOption('besoinsDir', 'Imposition', this)">Imposition</div>
            <div class="option-card" onclick="toggleOption('besoinsDir', 'Épargne perso', this)">Épargne perso</div>
            <div class="option-card" onclick="toggleOption('besoinsDir', 'Santé', this)">Santé</div>
        </div>
        <div class="nav-actions">
            <button class="btn-prev" onclick="showPage(7)">Précédent</button>
            <button class="btn-jad" onclick="nextFromPage8()">Suivant</button>
        </div>
    </div>

    <div id="page10" class="page">
        <div id="step-indicator" style="font-size:0.8rem; margin-bottom:10px;"></div>
        <h1 class="page-title" id="precision-title">Solution existante ?</h1>
        <p class="subtitle" id="precision-subtitle"></p>
        <div class="option-grid" style="max-width: 400px; margin: 0 auto 20px;">
            <div class="option-card" id="btn-has-sol-oui" onclick="setNeedSolution('Oui', this)">Oui</div>
            <div class="option-card" id="btn-has-sol-non" onclick="setNeedSolution('Non', this)">Non</div>
        </div>
        <div id="need-details-area" class="form-container" style="display:none;">
            <div class="field"><label>Produit / Établissement</label><input type="text" id="current-prod"></div>
            <div class="field"><label>Commentaires</label><textarea id="current-note"></textarea></div>
        </div>
        <div class="nav-actions">
            <button class="btn-prev" onclick="navPrecisionBack()">Précédent</button>
            <button class="btn-jad" onclick="navPrecisionNext()">Suivant</button>
        </div>
    </div>

    <div id="page11" class="page">
        <h1 class="page-title">Besoins <span style="color:var(--accent-gold)">Société</span></h1>
        <div class="option-grid grid-needs">
            <div class="option-card" onclick="toggleOption('besoinsSoc', 'Santé salariés', this)">Santé salariés</div>
            <div class="option-card" onclick="toggleOption('besoinsSoc', 'Prévoyance salariés', this)">Prévoyance salariés</div>
            <div class="option-card" onclick="toggleOption('besoinsSoc', 'Epargne salariale', this)">Epargne salariale</div>
            <div class="option-card" onclick="toggleOption('besoinsSoc', 'Transmission', this)">Transmission</div>
        </div>
        <div class="nav-actions">
            <button class="btn-prev" onclick="prevFromPage11()">Précédent</button>
            <button class="btn-jad" onclick="nextFromPage11()">Suivant</button>
        </div>
    </div>

    <div id="page-contact" class="page">
        <h1 class="page-title">Contact Client</h1>
        <div class="form-container">
            <div class="field"><label>E-mail</label><input type="email" id="in_client_mail"></div>
            <div class="field"><label>Téléphone</label><input type="tel" id="in_client_tel"></div>
        </div>
        <div class="nav-actions">
            <button class="btn-prev" onclick="prevFromContact()">Précédent</button>
            <button class="btn-jad" onclick="showPage(15)">Suivant</button>
        </div>
    </div>

    <div id="page15" class="page">
        <h1>Observations</h1>
        <div class="form-container">
            <textarea id="in_commentaire" placeholder="Notes complémentaires..." style="height:150px;"></textarea>
        </div>
        <div class="nav-actions">
            <button class="btn-prev" onclick="showPage('page-contact')">Précédent</button>
            <button class="btn-jad" onclick="compileSummary()">Synthèse</button>
        </div>
    </div>

    <div id="page16" class="page">
        <h1>Validation</h1>
        <div class="form-container" style="margin-bottom:10px;"><label>Votre e-mail</label><input type="email" id="in_collab_mail"></div>
        <div id="final-summary-full" class="summary-box"></div>
        <div class="nav-actions">
            <button class="btn-prev" onclick="showPage(15)">Précédent</button>
            <button class="btn-jad" onclick="sendAuditToMake()">Envoyer</button>
        </div>
    </div>

    <div id="page17" class="page">
        <h1>Audit transmis !</h1>
        <img src="https://static.wixstatic.com/media/372258_429b8cad6bec47ecb20949a0b1fe0142~mv2.png" height="60">
        <div class="nav-actions"><button class="btn-jad" onclick="location.reload()">Nouveau</button></div>
    </div>
</div>

<script>
    const MAKE_WEBHOOK_URL = "https://davsouf.app.n8n.cloud/webhook/audit-gestil";
    let auditData = {
        cabinet: "", collab: "", collabMail: "", client: "", forme: "", effectif: "", statut: "", treso: "",
        treso_montant: "", treso_bfr: "", treso_excedent: "", clientMail: "", clientTel: "",
        typesBesoins: [], besoinsDir: [], besoinsSoc: [], precisions: {}, commentaire: ""
    };
    let currentType = ""; let currentNeedIndex = 0;

    function handleCurrencyFormat(el) {
        let val = el.value.replace(/[^\d]/g, '');
        if (val) el.value = parseInt(val).toLocaleString('fr-FR') + " €";
    }

    function showPage(num) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        const target = typeof num === 'string' ? document.getElementById(num) : document.getElementById('page' + num);
        if (target) { target.classList.add('active'); window.scrollTo(0,0); }
        document.getElementById('main-header').style.visibility = (num === 1 || num === 17) ? "hidden" : "visible";
    }

    function toPage2() {
        const cab = document.getElementById('input-cabinet').value;
        const col = document.getElementById('input-collab').value;
        const cli = document.getElementById('input-client').value;
        if (!cab || !col || !cli) { alert("Champs requis"); return; }
        auditData.cabinet = cab; auditData.collab = col; auditData.client = cli;
        document.getElementById('welcome-text').innerHTML = `Bienvenue <span style="color:var(--accent-gold)">${col}</span>,<br>Audit de <span style="color:var(--accent-gold)">${cli}</span>`;
        if (cab.toLowerCase().includes("gestil")) {
            const url = "https://static.wixstatic.com/media/372258_fce967cb206e4d08bd4956051bcf546a~mv2.png";
            document.getElementById('center-logo-partner').src = url; document.getElementById('center-logo-partner').style.display = "block";
            document.getElementById('header-logo-partner').src = url; document.getElementById('header-logo-partner').style.display = "block";
        }
        showPage(2);
    }

    function savePage3() { auditData.forme = document.getElementById('select-forme').value; showPage(4); }
    function setOption(key, val, el) {
        auditData[key] = val;
        el.parentElement.querySelectorAll('.option-card').forEach(s => s.classList.remove('selected'));
        el.classList.add('selected');
    }
    function toggleOption(key, val, el) {
        const i = auditData[key].indexOf(val);
        if (i > -1) { auditData[key].splice(i, 1); el.classList.remove('selected'); }
        else { auditData[key].push(val); el.classList.add('selected'); }
    }
    function nextFromPage6() { if (auditData.treso === 'Oui') showPage('page6b'); else showPage(7); }
    function nextFromPage7() { if (auditData.typesBesoins.includes('Dirigeant')) showPage(8); else showPage(11); }
    function prevFromPage7() { if (auditData.treso === 'Oui') showPage('page6b'); else showPage(6); }
    function nextFromPage8() { currentType = "dir"; currentNeedIndex = 0; initPrecisionPage(); }
    function nextFromPage11() { currentType = "soc"; currentNeedIndex = 0; initPrecisionPage(); }

    function initPrecisionPage() {
        const needs = currentType === "dir" ? auditData.besoinsDir : auditData.besoinsSoc;
        const need = needs[currentNeedIndex];
        document.getElementById('precision-subtitle').innerText = `Objectif : ${need}`;
        document.getElementById('step-indicator').innerText = `Étape ${currentNeedIndex+1} / ${needs.length}`;
        
        // ✅ CORRECTIF ANTI-FUITE : On vide les champs à chaque chargement de page
        document.getElementById('current-prod').value = auditData.precisions[need]?.p || "";
        document.getElementById('current-note').value = auditData.precisions[need]?.n || "";
        document.querySelectorAll('#page10 .option-card').forEach(c => c.classList.remove('selected'));
        
        if (auditData.precisions[need]?.hasSolution) {
            const btn = auditData.precisions[need].hasSolution === 'Oui' ? 'btn-has-sol-oui' : 'btn-has-sol-non';
            document.getElementById(btn).classList.add('selected');
            document.getElementById('need-details-area').style.display = (auditData.precisions[need].hasSolution === 'Oui') ? 'block' : 'none';
        } else {
            document.getElementById('need-details-area').style.display = 'none';
        }
        showPage(10);
    }

    function setNeedSolution(val, el) {
        const needs = currentType === "dir" ? auditData.besoinsDir : auditData.besoinsSoc;
        const need = needs[currentNeedIndex];
        auditData.precisions[need] = { hasSolution: val };
        el.parentElement.querySelectorAll('.option-card').forEach(s => s.classList.remove('selected'));
        el.classList.add('selected');
        document.getElementById('need-details-area').style.display = (val === 'Oui') ? 'block' : 'none';
    }

    function navPrecisionNext() {
        const needs = currentType === "dir" ? auditData.besoinsDir : auditData.besoinsSoc;
        const need = needs[currentNeedIndex];
        if (auditData.precisions[need]?.hasSolution === 'Oui') {
            auditData.precisions[need].p = document.getElementById('current-prod').value;
            auditData.precisions[need].n = document.getElementById('current-note').value;
        }
        if (currentNeedIndex < needs.length - 1) { currentNeedIndex++; initPrecisionPage(); }
        else if (currentType === "dir" && auditData.typesBesoins.includes('Société')) showPage(11);
        else showPage('page-contact');
    }

    function navPrecisionBack() { if (currentNeedIndex > 0) { currentNeedIndex--; initPrecisionPage(); } else showPage(7); }
    function prevFromPage11() { if (auditData.typesBesoins.includes('Dirigeant')) { currentType="dir"; currentNeedIndex=auditData.besoinsDir.length-1; initPrecisionPage(); } else showPage(7); }
    function prevFromContact() { if (auditData.typesBesoins.includes('Société')) { currentType="soc"; currentNeedIndex=auditData.besoinsSoc.length-1; initPrecisionPage(); } else if (auditData.typesBesoins.includes('Dirigeant')) { currentType="dir"; currentNeedIndex=auditData.besoinsDir.length-1; initPrecisionPage(); } else showPage(7); }

    function compileSummary() {
        auditData.commentaire = document.getElementById('in_commentaire').value;
        let h = `<div class="summary-section"><b>Client :</b> ${auditData.client}<br><b>Cabinet :</b> ${auditData.cabinet}</div>`;
        for (let b in auditData.precisions) { h += `<div>• ${b} : <b>${auditData.precisions[b].hasSolution}</b></div>`; }
        document.getElementById('final-summary-full').innerHTML = h;
        showPage(16);
    }

    async function sendAuditToMake() {
        auditData.collabMail = document.getElementById('in_collab_mail').value;
        try {
            const res = await fetch(MAKE_WEBHOOK_URL, { method: "POST", headers: {"Content-Type": "application/json"}, body: JSON.stringify({ auditData }) });
            if (res.ok) showPage(17); else alert("Erreur d'envoi");
        } catch(e) { alert("Erreur réseau"); }
    }
</script>
</body>
</html>
